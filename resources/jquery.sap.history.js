/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 * (c) Copyright 2009-2012 SAP AG. All rights reserved
 */
jQuery.sap.declare("jquery.sap.history",false);(function($,w){var s="_skip",r=/\|id-[0-9]+-[0-9]+/,a=new RegExp(s+"[0-9]*$"),b=[],h=[],S={},c=0,d=undefined,I="|",H=[],e=false,f,g=false;$.sap.history=function(A){if(!jQuery.isPlainObject(A)){return}if(!g){var W=$(w),B=(w.location.href.split("#")[1]||"");W.bind('hashchange',k);if($.isArray(A.routes)){var i,C;for(i=0;i<A.routes.length;i++){C=A.routes[i];if(C.path&&C.handler){$.sap.history.addRoute(C.path,C.handler)}}}if(jQuery.isFunction(A.defaultHandler)){f=A.defaultHandler}h.push(B);if(B.length>1){W.trigger("hashchange",[true])}else{d=B}g=true}};$.sap.history.addHistory=function(i,A,B,V){var C,D;if(B===undefined){B=true}if(!V){D=n(i,A);C=o(D);if(C){D+=(I+C)}D+=(I+(B?"1":"0"))}else{D=m(d)}H.push(D);S[D]=true;w.location.hash=D;return D};$.sap.history.addVirtualHistory=function(){$.sap.history.addHistory("",undefined,false,true)};$.sap.history.addRoute=function(i,A,T){if(T){A=jQuery.proxy(A,T)}var R={};R.sIdentifier=i;R['action']=A;b.push(R);return this};$.sap.history.setDefaultHandler=function(i){f=i};$.sap.history.backToHash=function(i){i=i||"";var A;if(h.length===1){if($.isFunction(f)){f()}}else{A=j(d,i);if(A<0){w.history.go(A)}else{jQuery.sap.log.error("jQuery.sap.history.backToHash: "+i+"is not in the history stack or it's after the current hash")}}};$.sap.history.backThroughPath=function(P){P=P||"";P=w.encodeURIComponent(P);var i;if(h.length===1){if($.isFunction(f)){f()}}else{i=j(d,P,true);if(i<0){w.history.go(i)}else{jQuery.sap.log.error("jQuery.sap.history.backThroughPath: there's no history state which has the "+P+" identifier in the history stack before the current hash")}}};$.sap.history.back=function(i){if(h.length===1){if($.isFunction(f)){f($.sap.history.NavType.Back)}}else{if(!i){i=1}w.history.go(-1*i)}};$.sap.history.NavType={};$.sap.history.NavType.Back="_back";$.sap.history.NavType.Forward="_forward";$.sap.history.NavType.Bookmark="_bookmark";$.sap.history.NavType.Unknown="_unknown";function j(C,T,P){var A=$.inArray(C,h),B,i,D;if(A>0){if(P){for(i=A-1;i>=0;i--){D=h[i];if(D.indexOf(T)===0&&!t(D)){return i-A}}}else{B=$.inArray(T,h);if((B===-1)&&T.length===0){return-1*A}if((B>-1)&&(B<A)){return B-A}}}return 0}function k(E,M){var i=(w.location.href.split("#")[1]||"");i=l(i);if(M||!S[i]){H.push(i)}if(!e){e=true;if(H.length>0){var A=H.shift();if(S[A]){q(A);delete S[A]}else{v(A)}d=A}e=false}}function p(U){var i=U.indexOf("#");if(i===-1){return""}else if(i>0&&i!==U.length-1){return U.slice(i+1)}}function l(i,R){var A=i,B=i?i.indexOf("#"):-1,C,D;if(B===0){A=A.slice(B+1)}if(R){A=A.replace(r,"")}return A}function m(i){var P=i?i:"";if(t(P)){var A=P.lastIndexOf(s);P=P.slice(0,A)}return P+s+c++}function n(i,A){var E=w.encodeURIComponent(i);var B=w.encodeURIComponent(w.JSON.stringify(A));return E+I+B}function o(A){var B=$.inArray(d,h),T,i,C;if(B>-1){for(i=0;i<B+1;i++){C=h[i];if(C.slice(0,C.length-2)===A){return jQuery.sap.uid()}}}return""}function q(i){var A=$.inArray(d,h);if(!(A===-1||A===h.length-1)){h.splice(A+1,h.length-1-A)}h.push(i)}function t(i){return a.test(i)}function u(C,F){var A=$.inArray(C,h),i;if(A!==-1){if(F){for(i=A;i<h.length;i++){if(!t(h[i])){return i-A}}}else{for(i=A;i>=0;i--){if(!t(h[i])){return i-A}}return-1*(A+1)}}}function v(A){var R,B,i,P=A,C,D,N,E;if(d===undefined){D=y(A);if(!D.bBookmarkable){if(jQuery.isFunction(f)){f($.sap.history.NavType.Bookmark)}return}}if(A.length===0){if(jQuery.isFunction(f)){f($.sap.history.NavType.Back)}}else{N=jQuery.inArray(A,h);if(N===0){D=y(A);if(!D.bBookmarkable){if(jQuery.isFunction(f)){f($.sap.history.NavType.Back)}return}}if(t(A)){if(t(d)){B=u(A,false);w.history.go(B)}else{var F=new RegExp(z(d+s)+"[0-9]*$");if(F.test(A)){B=u(A,true);if(B){w.history.go(B)}else{w.history.back()}}else{B=u(A,false);w.history.go(B)}}}else{if(N===-1){E=$.sap.history.NavType.Unknown;h.push(A)}else{if(jQuery.inArray(d,h,N+1)===-1){E=$.sap.history.NavType.Forward}else{E=$.sap.history.NavType.Back}}D=y(A);if(D){R=x(D.sIdentifier);if(R){R.action.apply(null,[D.oStateData,E])}}else{jQuery.sap.log.error("hash format error! The current Hash: "+A)}}}}function x(A){var i;for(i=0;i<b.length;i++){if(b[i].sIdentifier===A){return b[i]}}}function y(A){if(t(A)){var i=A.lastIndexOf(s);A=A.slice(0,i)}var P=A.split(I),R={};if(P.length===4||P.length===3){R.sIdentifier=w.decodeURIComponent(P[0]);R.oStateData=w.JSON.parse(w.decodeURIComponent(P[1]));if(P.length===4){R.uid=P[2]}R.bBookmarkable=P[P.length-1]==="0"?false:true;return R}}function z(T){return T.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}})(jQuery,this);
